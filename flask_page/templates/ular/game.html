{# ular/game.html #}
{% extends "ular/base.html" %}


{% block content %}
    <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Snakes and Ladders</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
    }
    .board {
      display: grid;
      grid-template-columns: repeat(10, 20px);
      grid-template-rows: repeat(10, 20px);
      gap: 1px;
      margin: 20px auto;
      width: 200px;
      height: 200px;
      /* border: 2px solid black; */
    }
    .cell {
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 12px;
      background-color: #f0f0f0;
      border: 1px solid #ccc;
    }
    .cell:nth-child(odd) {
      background-color: #d4e6f1;
    }
    .snake {
      background-color: #ffcccc !important;
    }
    .ladder {
      background-color: #ccffcc !important;
    }
    .player {
      width: 20px;
      height: 20px;
      background-color: red;
      border-radius: 50%;
      position: absolute;
      /* position: relative; */
      animation: slide 1s ease-in-out;
    }
    @keyframes slide {
      from {
        transform: translateY(0px);
      }
      to {
        transform: translateY(0);
      }
    }
  </style>
</head>
    
    <br/>
    <div>
        <div id="divrefreshgame">
            <input type="text" placeholder="Game Code" id="statecode" oninput="this.value = this.value.toUpperCase();"/>
            <button onclick="refreshgame();">Refresh game</button>
            <input type="text" placeholder="Player" id="playercode"/>
        </div>
        <div id="divcreatejoin" style="display: flex; gap: 0; border-bottom: 2px solid #ccc;">
            <button onclick="opentab('create', 'yes');" style="padding: 10px 20px; border: none; background-color: #f0f0f0; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px;">Create</button>
            <button onclick="opentab('join', 'yes');" style="padding: 10px 20px; border: none; background-color: #f0f0f0; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px;">Join</button>
        </div>
        <br/>
        <div id="divboard">
            <div id="boardinfo">
                <p id="codeR">Code: </p>
                <p id="playerR">Player: </p>
                <p id="playersR">Players: </p>
                <p id="colorR">Color: </p>
                <p id="posR">Pos: </p>
                <p id="stateR">State: </p>
            </div>
            <div class="board" id="board">
            </div>
            <!-- <button id="rollDice">rexample</button> -->
            <div id="boardinfo2">
                <button type="button" onclick="rolldice()">roll</button>
                <p id="diceR">Dice: </p>
            </div>
        </div>
        <div id="divcreateroom">
            <p>Create Room</p>
            <form>
                <div>
                    <input type="text" id="playercreateroom" placeholder="player" />
                    <input type="text" id="colorcreateroom" placeholder="color (green/yellow/blue etc.)" />
                    <button type="button" onclick="createroom()">Create</button>
                </div>
            </form>
            <!-- <pre id="outputcreateroom"></pre> -->
        </div>
        <div id="divjoinroom">
            <p>Join Room</p>
            <form>
                <div>
                    <input type="text" id="codejoinroom" placeholder="code" oninput="this.value = this.value.toUpperCase();"/>
                    <input type="text" id="playerjoinroom" placeholder="player" />
                    <input type="text" id="colorjoinroom" placeholder="color (green/yellow/blue etc.)" />
                    <button type="button" onclick="joinroom()">Join</button>
                </div>
            </form>
            <!-- <pre id="outputjoinroom"></pre> -->
        </div>
        <div style="display:none;">
            <p>api/ular/state</p>
            <form>
                <input type="text" id="codestate" placeholder="code" />
                <button type="button" onclick="state()">Submit</button>
            </form>
            <pre id="outputstate"></pre>
            <br/>
            <br/>
            <p>api/ular/startgame</p>
            <form>
                <input type="text" id="codestartgame" placeholder="code" />
                <button type="button" onclick="startgame()">Submit</button>
            </form>
            <pre id="outputstartgame"></pre>
            <br/>
            <br/>
            <p>api/ular/rolldice</p>
            <form>
                <input type="text" id="coderolldice" placeholder="code" />
                <input type="text" id="playerrolldice" placeholder="player" />
                <button type="button" onclick="rolldice()">Submit</button>
            </form>
            <pre id="outputrolldice"></pre>
            <br/>
            <br/>
            <p>api/ular/submitanswer</p>
            <form>
                <input type="text" id="codesubmitanswer" placeholder="code" />
                <input type="text" id="playersubmitanswer" placeholder="player" />
                <input type="text" id="answersubmitanswer" placeholder="answer" />
                <button type="button" onclick="submitanswer()">Submit</button>
            </form>
            <pre id="outputsubmitanswer"></pre>
        </div>

        <div id="divquestion">
            <div id="questionplayertext" style="margin-bottom:15px;font-weight: bold;">Answerer: </div>
            <div id="questiontext">Question: ayam</div>
            <button id="a1text" onclick="jawab(this.innerHTML)">1</button>
            <button id="a2text" onclick="jawab(this.innerHTML)">2</button>
            <button id="a3text" onclick="jawab(this.innerHTML)">3</button>
            <button id="a4text" onclick="jawab(this.innerHTML)">4</button>
        </div>

        
        <pre id="outputall"></pre>
    </div>
    <script>

        function opentab(tab, close = "no")
        {
            const divcreateroom = document.getElementById('divcreateroom');
            const divjoinroom = document.getElementById('divjoinroom');
            const divboard = document.getElementById('divboard');

            if (tab == "create")
            {
                divcreateroom.style.display = "block";
                if (close == "yes")
                {
                    divjoinroom.style.display = "none";
                    divboard.style.display = "none";
                }
            }
            else if (tab == "join")
            {
                divjoinroom.style.display = "block";
                if (close == "yes")
                {
                    divcreateroom.style.display = "none";
                    divboard.style.display = "none";
                }
            }
            else if (tab == "board")
            {
                divboard.style.display = "block";
                if (close == "yes")
                {
                    divcreateroom.style.display = "none";
                    divjoinroom.style.display = "none";
                }
            }
        }

        function showdiv(id)
        {
            const div = document.getElementById(id);
            div.style.display = "block";
        }
        function hidediv(id)
        {
            const div = document.getElementById(id);
            div.style.display = "none";
        }

        //starting screen
        showdiv("divcreatejoin");
        showdiv("divcreateroom");
        hidediv("divjoinroom");
        hidediv("divrefreshgame");
        hidediv("divboard");
        hidediv("divquestion");

    </script>
    <script>
        const board = document.getElementById('board');
        const diceR = document.getElementById('diceR');
        const rollDice = document.getElementById('rollDice');

        // Generate the board dynamically
        for (let i = 100; i > 0; i--) {
            const cell = document.createElement('div');
            cell.classList.add('cell');
            cell.textContent = i;

            // Add snakes and ladders based on conf.csv
            if (i === 16) cell.classList.add('snake');
            if (i === 47) cell.classList.add('snake');
            if (i === 49) cell.classList.add('snake');
            if (i === 56) cell.classList.add('snake');
            if (i === 62) cell.classList.add('snake');
            if (i === 64) cell.classList.add('snake');
            if (i === 87) cell.classList.add('snake');
            if (i === 93) cell.classList.add('snake');
            if (i === 95) cell.classList.add('snake');
            if (i === 98) cell.classList.add('snake');
            if (i === 1) cell.classList.add('ladder');
            if (i === 4) cell.classList.add('ladder');
            if (i === 9) cell.classList.add('ladder');
            if (i === 21) cell.classList.add('ladder');
            if (i === 28) cell.classList.add('ladder');
            if (i === 36) cell.classList.add('ladder');
            if (i === 51) cell.classList.add('ladder');
            if (i === 71) cell.classList.add('ladder');
            if (i === 80) cell.classList.add('ladder');

            board.appendChild(cell);
        }

        // Store player positions and colors
        let playerPositions = {}; // playerId -> position
        let playerColors = {}; // playerId -> color

        // Move player function
        function movePlayer(playerId, oldPos, newPos) {
            // Remove player from old position if it exists
            if (oldPos > 0 && oldPos !== newPos) {
                const oldCellIndex = 100 - oldPos;
                const oldCell = board.children[oldCellIndex];
                if (oldCell) {
                    // Remove this player from the old cell
                    const playerDivs = oldCell.querySelectorAll('.player');
                    let newContent = oldPos;
                    playerDivs.forEach(div => {
                        const pId = div.getAttribute('data-player-id');
                        if (pId !== playerId) {
                            newContent += `<div class="player" data-player-id="${pId}" style="background-color: ${getPlayerColor(pId)}"></div>`;
                        }
                    });
                    oldCell.innerHTML = newContent;
                }
            }
            
            // Add player to new position
            const cellIndex = 100 - newPos;
            const cell = board.children[cellIndex];
            
            if (cell) {
                // Store the current content (cell number)
                let cellContent = newPos;
                
                // Check if there are already players on this cell
                let existingPlayers = [];
                if (cell.querySelectorAll('.player').length > 0) {
                    // Get existing player data
                    cell.querySelectorAll('.player').forEach(playerDiv => {
                        const existingPlayerId = playerDiv.getAttribute('data-player-id');
                        existingPlayers.push(existingPlayerId);
                    });
                }
                
                // Add the new player to the list
                existingPlayers.push(playerId);
                
                // Update the cell with all players
                let html = `${cellContent}`;
                existingPlayers.forEach(pId => {
                    html += `<div class="player" data-player-id="${pId}" style="background-color: ${getPlayerColor(pId)}"></div>`;
                });
                cell.innerHTML = html;
                
                // Update stored position
                playerPositions[playerId] = newPos;
            }
        }
        
        // Helper function to get player color
        function getPlayerColor(playerId) {
            return playerColors[playerId] || 'gray';
        }
    </script>

    <script>

        function setcode(code) {
            const result = document.getElementById("codeR");
            result.innerHTML = "code: " +code;
        }
        function setplayer(player) {
            const result = document.getElementById("playerR");
            if (player == "" || player == undefined)
            {
                result.innerHTML = "";
            }
            else
            {
                result.innerHTML = "player: " +player;
            }
        }
        function setplayers(players) {
            const result = document.getElementById("playersR");
            if (players == "" || players == undefined)
            {
                result.innerHTML = "";
            }
            else
            {
                var html = "";
                html += "<div>";

                players.forEach(item => {
                    html += "<div style='display:flex;justify-content:center;align-items:center;'>";
                    html += `ID: ${item.player}, color: ${item.color}, pos: ${item.pos} `
                    html += `<div style='border-radius:24px;background-color:${item.color};width:28px;height:28px;'> </div> `
                    html += "</div>"
                    setpos("")
                    setcolor("")

                });
                html += "</div>"
                result.innerHTML = html;
            }
        }
        function setcolor(color) {
            const result = document.getElementById("colorR");
            if (color == "" || color == undefined)
            {
                result.innerHTML = "";
            }
            else
            {
                result.innerHTML = "color: " +color;
            }
        }
        function setpos(pos) {
            const result = document.getElementById("posR");
            if (pos == "" || pos == undefined)
            {
                result.innerHTML = "";
            }
            else
            {
                result.innerHTML = "pos: " +pos;
            }
        }
        function setstate(state) {
            const result = document.getElementById("stateR");
            if (state == "waiting")
            {
                result.innerHTML = "state: " +state + "<button onclick='startgame();'>Start</button>";
            }
            else
            {
                result.innerHTML = "state: " +state;
            }
            
        }
        function setdice(dice) {
            const result = document.getElementById("diceR");
            if (dice == "" || dice == undefined)
            {
                result.innerHTML = "";
            }
            else
            {
                result.innerHTML = "dice: 🎲" +dice;
            }
            
        }
        
        function createroom() {
            const player = document.getElementById("playercreateroom").value;
            const color = document.getElementById("colorcreateroom").value;
            const outputall = document.getElementById("outputall");
            const code2 = document.getElementById("statecode");
            const player2 = document.getElementById("playercode");
            outputall.innerHTML = "Creating room...";
            fetch(`/api/ular/createroom?player=${encodeURIComponent(player)}&color=${encodeURIComponent(color)}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            }).then(response => response.json()).then(data => {
                console.log(data);
                if (data.status == "ok")
                {
                    var message = data.message;
                    outputall.innerHTML = message;
                    // setcode(data.code);
                    // setplayer(data.player);
                    // setcolor(data.color);
                    // setpos(data.pos);
                    // setstate(data.state);
                    // opentab("board", "yes");
                    hidediv("divcreatejoin");
                    hidediv("divcreateroom");
                    hidediv("divjoinroom");
                    hidediv("divquestion");
                    code2.value = data.code;
                    player2.value = data.player;
                    showdiv("divrefreshgame");
                    showdiv("divboard");

                    refreshgame();
                    // Start auto-refresh when successfully creating a room
                    startAutoRefresh();
                    // outputcreateroom.innerHTML = JSON.stringify(data, null, 2);
                }
                else
                {
                    if (data.status == "error")
                    {
                        var message = data.message;
                        outputall.innerHTML = message;
                    } 
                    else
                    {
                        var message = "Something error when connecting server. Please check your internet connection.";
                        outputall.innerHTML = message;
                    }
                }
            }).catch(error => {
                outputall.innerHTML = "Error: " + error;
            });
        }

        function joinroom() {
            const code = document.getElementById("codejoinroom").value;
            const player = document.getElementById("playerjoinroom").value;
            const color = document.getElementById("colorjoinroom").value;
            const outputall = document.getElementById("outputall");
            const code2 = document.getElementById("statecode");
            const player2 = document.getElementById("playercode");
            outputall.innerHTML = "Joining room...";
            fetch(`/api/ular/joinroom?code=${encodeURIComponent(code)}&player=${encodeURIComponent(player)}&color=${encodeURIComponent(color)}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            }).then(response => response.json()).then(data => {
                console.log(data);
                if (data.status == "ok")
                {
                    var message = data.message;
                    outputall.innerHTML = message;
                    // setcode(data.code);
                    // setplayer(data.player);
                    // setplayers(data.players);
                    // setcolor(data.color);
                    // setpos(data.pos);
                    // setstate(data.state);
                    // opentab("board", "yes");
                    hidediv("divcreatejoin");
                    hidediv("divcreateroom");
                    hidediv("divjoinroom");
                    hidediv("divquestion");
                    code2.value = data.code;
                    player2.value = data.player;
                    showdiv("divrefreshgame");
                    showdiv("divboard");
                    
                    refreshgame();
                    // Start auto-refresh when successfully joining a room
                    startAutoRefresh();
                    // outputcreateroom.innerHTML = JSON.stringify(data, null, 2);
                }
                else
                {
                    if (data.status == "error")
                    {
                        var message = data.message;
                        outputall.innerHTML = message;
                    } 
                    else
                    {
                        var message = "Something error when connecting server. Please check your internet connection.";
                        outputall.innerHTML = message;
                    }
                }
            }).catch(error => {
                outputall.innerHTML = "Error: " + error;
            });
        }

        
        function refreshgame()
        {
            const code = document.getElementById("statecode").value;
            const outputall = document.getElementById("outputall");
            // outputall.innerHTML = "Refreshing...";
            fetch(`/api/ular/state?code=${encodeURIComponent(code)}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            }).then(response => response.json()).then(data => {
                console.log(data);
                if (data.status == "ok")
                {
                    var message = data.message;
                    outputall.innerHTML = message;
                    setcode(data.code);
                    setplayer(data.player);
                    setplayers(data.players);
                    setcolor("");
                    setpos("");
                    setstate(data.state);
                    opentab("board", "yes");

                    //move player UI
                    data.players.forEach(playerData => {
                        const playerId = playerData.player;     // Unique player identifier
                        const oldPos = playerPositions[playerId] || 0;   // Previous position from stored state
                        const newPos = playerData.pos;      // New position
                        playerColors[playerId] = playerData.color; // Store player color
                        movePlayer(playerId, oldPos, newPos);
                    });

                    hidediv("divquestion");
                    // showdiv("boardinfo");
                    showdiv("boardinfo2");

                    // console.log(data.question.length);
                    if (data.question.length != 0)
                    {
                        // outputall.innerHTML = message;
                        showdiv("divquestion");
                        // hidediv("divboard");
                        // hidediv("boardinfo");
                        hidediv("boardinfo2");
                        document.getElementById("questionplayertext").innerHTML = "Answerer: " + data.turn;
                        document.getElementById("questiontext").innerHTML = data.question[0].question;
                        document.getElementById("a1text").innerHTML = data.question[0].a1;
                        document.getElementById("a2text").innerHTML = data.question[0].a2;
                        document.getElementById("a3text").innerHTML = data.question[0].a3;
                        document.getElementById("a4text").innerHTML = data.question[0].a4;
                    }
                    // outputcreateroom.innerHTML = JSON.stringify(data, null, 2);
                }
                else
                {
                    if (data.status == "error")
                    {
                        var message = data.message;
                        outputall.innerHTML = message;
                    } 
                    else
                    {
                        var message = "Something error when connecting server. Please check your internet connection.";
                        outputall.innerHTML = message;
                    }
                }
            }).catch(error => {
                outputall.innerHTML = "Error: " + error;
            });
        }

        function startgame() {
            const code = document.getElementById("statecode").value;
            const outputall = document.getElementById("outputall");
            outputall.innerHTML = "Starting game...";
            fetch(`/api/ular/startgame?code=${encodeURIComponent(code)}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            }).then(response => response.json()).then(data => {
                console.log(data);
                if (data.status == "ok")
                {
                    var message = data.message;
                    outputall.innerHTML = message;
                    setplayer("");
                    setplayers(data.players);
                    setcolor("");
                    setpos("");
                    setstate(data.state);
                }
                else
                {
                    if (data.status == "error")
                    {
                        var message = data.message;
                        outputall.innerHTML = message;
                    } 
                    else
                    {
                        var message = "Something error when connecting server. Please check your internet connection.";
                        outputall.innerHTML = message;
                    }
                }
            }).catch(error => {
                outputall.innerHTML = "Error: " + error;
            });
        }

        function rolldice() {
            const code = document.getElementById("statecode").value;
            const player = document.getElementById("playercode").value;
            const outputall = document.getElementById("outputall");
            // outputall.innerHTML = "Rolling dice...";
            fetch(`/api/ular/rolldice?code=${encodeURIComponent(code)}&player=${encodeURIComponent(player)}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            }).then(response => response.json()).then(data => {
                console.log(data);
                if (data.status == "ok")
                {
                    var message = data.message;
                    outputall.innerHTML = message;
                    setcode(data.code);
                    setplayer(data.player);
                    setplayers(data.players);
                    setcolor("");
                    setpos("");
                    setstate(data.state);
                    setdice(data.dice);
                    
                    //move player UI
                    data.players.forEach(playerData => {
                        const playerId = playerData.player;     // Unique player identifier
                        const oldPos = playerPositions[playerId] || 0;   // Previous position from stored state
                        const newPos = playerData.pos;      // New position
                        playerColors[playerId] = playerData.color; // Store player color
                        movePlayer(playerId, oldPos, newPos);
                    });

                    hidediv("divquestion");
                    // showdiv("boardinfo");
                    showdiv("boardinfo2");
                    

                    // opentab("board", "yes");
                    if (data.question.length != 0)
                    {
                        showdiv("divquestion");
                        // hidediv("divboard");
                        // hidediv("boardinfo");
                        hidediv("boardinfo2");
                        document.getElementById("questionplayertext").innerHTML = "Answerer: " + data.turn;
                        document.getElementById("questiontext").innerHTML = data.question[0].question;
                        document.getElementById("a1text").innerHTML = data.question[0].a1;
                        document.getElementById("a2text").innerHTML = data.question[0].a2;
                        document.getElementById("a3text").innerHTML = data.question[0].a3;
                        document.getElementById("a4text").innerHTML = data.question[0].a4;
                    }
                }
                else
                {
                    if (data.status == "error")
                    {
                        var message = data.message;
                        outputall.innerHTML = message;
                    } 
                    else
                    {
                        var message = "Something error when connecting server. Please check your internet connection.";
                        outputall.innerHTML = message;
                    }
                }
            }).catch(error => {
                outputall.innerHTML = "Error: " + error;
            });
        }

        function jawab(answer) {
            // console.log("aaaaa");
            console.log(answer);
            // showdiv("divboard");
            const code = document.getElementById("statecode").value;
            const player = document.getElementById("playercode").value;
            const outputall = document.getElementById("outputall");
            // outputall.innerHTML = "Submitting answer...";
            fetch(`/api/ular/submitanswer?code=${encodeURIComponent(code)}&player=${encodeURIComponent(player)}&answer=${encodeURIComponent(answer)}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            }).then(response => response.json()).then(data => {
                console.log(data);
                if (data.status == "ok")
                {
                    var message = data.message;
                    // outputall.innerHTML = message;
                    //javascript popup message message
                    alert(message);

                    setplayers(data.players);
                    // setpos(data.pos);
                    setstate(data.state);
                    
                    //move player UI
                    data.players.forEach(playerData => {
                        const playerId = playerData.player;     // Unique player identifier
                        const oldPos = playerPositions[playerId] || 0;   // Previous position from stored state
                        const newPos = playerData.pos;      // New position
                        playerColors[playerId] = playerData.color; // Store player color
                        movePlayer(playerId, oldPos, newPos);
                    });
                    
                    hidediv("divquestion");
                    // showdiv("boardinfo");
                    showdiv("boardinfo2");
                }
                else
                {
                    if (data.status == "error")
                    {
                        var message = data.message;
                        outputall.innerHTML = message;
                    } 
                    else
                    {
                        var message = "Something error when connecting server. Please check your internet connection.";
                        outputall.innerHTML = message;
                    }
                }
            }).catch(error => {
                outputall.innerHTML = "Error: " + error;
            });
        }

        function submitanswer() {
            const code = document.getElementById("codesubmitanswer").value;
            const player = document.getElementById("playersubmitanswer").value;
            const answer = document.getElementById("answersubmitanswer").value;
            const output = document.getElementById("outputsubmitanswer");
            output.innerHTML = "Submitting answer...";
            fetch(`/api/ular/submitanswer?code=${encodeURIComponent(code)}&player=${encodeURIComponent(player)}&answer=${encodeURIComponent(answer)}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            }).then(response => response.json()).then(data => {
                output.innerHTML = JSON.stringify(data, null, 2);
            }).catch(error => {
                output.innerHTML = "Error: " + error;
            });
        }

        function reset() {
            const outputcreateroom = document.getElementById("outputcreateroom");
            outputcreateroom.innerHTML = "";
            const outputjoinroom = document.getElementById("outputjoinroom");
            outputjoinroom.innerHTML = "";
            const outputstate = document.getElementById("outputstate");
            outputstate.innerHTML = "";
            const outputstartgame = document.getElementById("outputstartgame");
            outputstartgame.innerHTML = "";
            const outputrolldice = document.getElementById("outputrolldice");
            outputrolldice.innerHTML = "";
        }
        
        let refreshInterval = null;
        
        function startAutoRefresh() {
            if (refreshInterval === null) {
                refreshInterval = setInterval(refreshgame, 1000);
            }
        }
        
        function stopAutoRefresh() {
            if (refreshInterval !== null) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
    </script>
    
{% endblock %}